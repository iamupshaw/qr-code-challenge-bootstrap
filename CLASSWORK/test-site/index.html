// music-backend/server.js
const express = require('express');
const cors = require('cors');
const dotenv = require('dotenv');
const Stripe = require('stripe');
const AWS = require('aws-sdk');

dotenv.config();
const app = express();
app.use(cors());
app.use(express.json());

const stripe = Stripe(process.env.STRIPE_SECRET_KEY);

const s3 = new AWS.S3({
accessKeyId: process.env.AWS_ACCESS_KEY,
secretAccessKey: process.env.AWS_SECRET_KEY,
region: process.env.AWS_REGION,
});

// Sample track info (can be from DB later)
const TRACKS = {
"track-1": {
name: "One 4 Her (Single)",
price: 199, // $1.99
s3Key: "track-1.mp3",
},
};

app.post('/create-checkout-session', async (req, res) => {
const { trackId } = req.body;
const track = TRACKS[trackId];

const session = await stripe.checkout.sessions.create({
payment_method_types: ['card'],
line_items: [{
price_data: {
currency: 'usd',
product_data: { name: track.name },
unit_amount: track.price,
},
quantity: 1,
}],
mode: 'payment',
success_url: `${process.env.FRONTEND_URL}/success?track=${trackId}`,
cancel_url: `${process.env.FRONTEND_URL}/cancel`,
});

res.json({ url: session.url });
});

app.get('/download/:trackId', (req, res) => {
const track = TRACKS[req.params.trackId];

const params = {
Bucket: process.env.AWS_BUCKET_NAME,
Key: track.s3Key,
Expires: 60 * 5,
};

const url = s3.getSignedUrl('getObject', params);
res.json({ url });
});

app.listen(3001, () => console.log('Server running on port 3001'));
STRIPE_SECRET_KEY=your_stripe_secret_key
AWS_ACCESS_KEY=your_aws_key
AWS_SECRET_KEY=your_aws_secret
AWS_REGION=us-east-1
AWS_BUCKET_NAME=your-bucket-name
FRONTEND_URL=http://localhost:5173